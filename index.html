<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #fff;
            --text-color: #000;
            --hint-color: #999;
            --btn-color: rgb(48, 37, 37);
            --btn-text: #fff;
            --secondary-bg: #f0f0f0;
            --active-bg: #fff;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 15px; padding-bottom: 40px; }
        label { display: block; margin-top: 15px; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--hint-color); text-transform: uppercase; letter-spacing: 0.5px; }
        select, input, textarea { width: 100%; padding: 14px; border: 1px solid transparent; border-radius: 12px; background-color: var(--secondary-bg); color: var(--text-color); font-size: 16px; box-sizing: border-box; outline: none; transition: 0.2s; }
        select:focus, input:focus, textarea:focus { border-color: var(--btn-color); background-color: var(--bg-color); box-shadow: 0 0 0 3px rgba(51, 144, 236, 0.1); }
        .row { display: flex; gap: 12px; } .col { flex: 1; }
        .city-buttons { display: flex; gap: 10px; } .city-buttons input { display: none; }
        .city-buttons label { flex: 1; padding: 14px; text-align: center; background-color: var(--secondary-bg); color: var(--text-color); border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
        .city-buttons input:checked+label { background-color: var(--btn-color); color: var(--btn-text); border-color: var(--btn-color); }
        .tourist-card { background-color: #fff; border: 1px solid #e0e0e0; border-radius: 12px; padding: 10px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); }
        .tourist-name { font-size: 14px; font-weight: 700; margin-bottom: 5px; color: var(--btn-color); }
        .submit-btn { width: 100%; padding: 16px; margin-top: 30px; border: none; border-radius: 14px; background-color: var(--btn-color); color: var(--btn-text); font-size: 16px; font-weight: 700; cursor: pointer; }
        .smart-select-box { background: var(--active-bg); padding: 15px; border-radius: 12px; border: 1px solid var(--btn-color); margin-bottom: 20px; }
        #date_input { text-align: center; font-weight: bold; font-size: 18px; border: 1px solid #ddd; }
    </style>
</head>
<body>

<div id="step_1">
    <div class="smart-select-box">
        <label>üìÖ 1. –î–∞—Ç–∞ –≤—ã–ª–µ—Ç–∞:</label>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="date_input" placeholder="13.12" style="flex: 1;">
            <button type="button" onclick="handleSearch()" style="background: var(--btn-color); color: white; border: none; border-radius: 12px; padding: 0 20px; font-weight: bold;">–ù–∞–π—Ç–∏</button>
        </div>
        <label style="margin-top: 15px;">üì¶ 2. –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–∫–µ—Ç:</label>
        <select id="pkg_name" disabled><option value="">–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–∞–π—Ç–∏¬ª</option></select>
    </div>

    <input type="hidden" id="sheet_name_hidden">
    <input type="hidden" id="table_id_hidden">

    <label>üõ´ –ì–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞:</label>
    <div class="city-buttons">
        <input type="radio" name="city" id="c_ala" value="Almaty" checked><label for="c_ala">Almaty</label>
        <input type="radio" name="city" id="c_ast" value="Astana"><label for="c_ast">Astana</label>
    </div>

    <label>üë• –ü–∞–ª–æ–º–Ω–∏–∫–∏:</label>
    <div id="pilgrims-container"></div>

    <div class="row">
        <div class="col"><label>AVIA:</label><input type="text" id="avia" placeholder="–ó–∞–ø—Ä–æ—Å"></div>
        <div class="col"><label>VISA:</label>
            <select id="visa">
                <option value="UMRAH VISA">UMRAH VISA</option>
                <option value="TOUR VISA">TOUR VISA</option>
                <option value="NO VISA">NO VISA</option>
                <option value="OWN VISA">OWN VISA</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="col"><label>–¢–∏–ø –Ω–æ–º–µ—Ä–∞:</label>
            <select id="room">
                <option value="Quad">Quadro</option>
                <option value="Triple">Triple</option>
                <option value="Double">Double</option>
                <option value="Single">Single</option>
            </select>
        </div>
        <div class="col"><label>–ü–∏—Ç–∞–Ω–∏–µ:</label>
            <select id="meal">
                <option value="BB">BB</option>
                <option value="HB">HB</option>
                <option value="FB">FB</option>
                <option value="RO">RO</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="col"><label>–°—É–º–º–∞ –ø–∞–∫–µ—Ç–∞:</label><input type="tel" id="price" inputmode="numeric"></div>
        <div class="col"><label>–û–ø–ª–∞—á–µ–Ω–æ:</label><input type="tel" id="paid" inputmode="numeric" value="0"></div>
    </div>

    <details style="margin-top: 20px; background: #fff; border-radius: 12px; padding: 5px; border: 1px solid #ddd;">
        <summary style="font-weight: 600; padding: 10px; cursor: pointer;">üìÇ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</summary>
        <div style="padding: 10px;">
            <label>–†–µ–≥–∏–æ–Ω:</label>
            <select id="region"><option value="Almaty">Almaty</option><option value="Astana">Astana</option><option value="Shymkent">Shymkent</option></select>
            <label>–î–æ–≥–æ–≤–æ—Ä:</label><input type="text" id="contract" placeholder="-">
            <label>–ú–µ–Ω–µ–¥–∂–µ—Ä:</label><input type="text" id="manager" readonly style="opacity: 0.7; background: #e0e0e0;">
            <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label><textarea id="comment" rows="2"></textarea>
        </div>
    </details>

    <button class="submit-btn" onclick="goToStep2()">‚û°Ô∏è –ü–ï–†–ï–ô–¢–ò –ö –†–ê–ó–ú–ï–©–ï–ù–ò–Æ</button>
</div>

<div id="step_2" style="display: none;">
    <div class="smart-select-box">
        <h3 style="color: var(--btn-color); text-align: center; margin-top: 0;">üõè –®–∞–≥ 2: –†–∞–∑–º–µ—â–µ–Ω–∏–µ</h3>

        <div id="group_logic" style="display: none; margin-bottom: 20px;">
            <label>–ö–∞–∫ —Ä–∞–∑–º–µ—â–∞—Ç—å –≥—Ä—É–ø–ø—É?</label>
            <div class="city-buttons">
                <input type="radio" name="place_mode" id="m_fam" value="family" checked><label for="m_fam">üë®‚Äçüë©‚Äçüëß –í–º–µ—Å—Ç–µ</label>
                <input type="radio" name="place_mode" id="m_sep" value="separate"><label for="m_sep">üöª –†–∞–∑–¥–µ–ª—å–Ω–æ</label>
            </div>
        </div>

        <label>–ú–µ—Ç–æ–¥ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</label>
        <div class="city-buttons" style="flex-direction: column; gap: 8px;">
            <input type="radio" name="place_method" id="meth_auto" value="auto" checked onchange="togglePlacementFields()"><label for="meth_auto">üé≤ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–¢–µ—Ç—Ä–∏—Å)</label>
            <input type="radio" name="place_method" id="meth_pick" value="pick" onchange="togglePlacementFields()"><label for="meth_pick">ü§ù –ü–æ–¥—Å–µ–ª–∏—Ç—å (–°–ø–∏—Å–æ–∫ –º–µ—Å—Ç)</label>
            <input type="radio" name="place_method" id="meth_man" value="manual" onchange="togglePlacementFields()"><label for="meth_man">üìç –í –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å—Ç—Ä–æ–∫—É</label>
        </div>

        <div id="rooms_list_container" style="display: none; margin-top: 15px;">
            <label>–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ:</label>
            <select id="room_select"></select>
        </div>

        <div id="manual_row_container" style="display: none; margin-top: 15px;">
            <label>–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ:</label>
            <input type="number" id="manual_row_input" placeholder="–ù–∞–ø—Ä. 145">
        </div>
    </div>

    <button class="submit-btn" onclick="finalSubmit()">‚úÖ –ó–ê–í–ï–†–®–ò–¢–¨ –ò –ó–ê–ü–ò–°–ê–¢–¨</button>
    <button type="button" onclick="backToStep1()" style="background: none; color: gray; border: none; width: 100%; margin-top: 10px; cursor: pointer;">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –¥–∞–Ω–Ω—ã–º</button>
</div>

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();

    // üõë –ê–î–†–ï–° –¢–í–û–ï–ì–û NGROK
    const API_URL = "https://gainless-computably-pablo.ngrok-free.dev";
    let pilgrimsCount = 0;

    // --- –ü–û–ò–°–ö –ü–ê–ö–ï–¢–û–í ---
    async function handleSearch() {
        let date = document.getElementById('date_input').value.trim().replace(/[\/\s,]/g, '.');
        if (date.length < 5) return alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –ø–æ–ª–Ω–æ—Å—Ç—å—é (–Ω–∞–ø—Ä. 13.12)");
        const pkgSelect = document.getElementById('pkg_name');
        pkgSelect.innerHTML = '<option>‚è≥ –ü–æ–∏—Å–∫...</option>';
        try {
            const resp = await fetch(`${API_URL}/api/packages?date=${date}`, { headers: {"ngrok-skip-browser-warning":"1"} });
            const res = await resp.json();
            if (res.found) {
                pkgSelect.disabled = false;
                pkgSelect.innerHTML = '<option value="" disabled selected>‚úÖ –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–∫–µ—Ç</option>';
                res.data.forEach(item => {
                    let opt = document.createElement('option');
                    opt.value = item.n; opt.innerText = item.n;
                    opt.dataset.sheet = item.s; opt.dataset.table = item.t;
                    pkgSelect.appendChild(opt);
                });
            } else { pkgSelect.innerHTML = `<option>‚ùå ${res.error || '–†–µ–π—Å–æ–≤ –Ω–µ—Ç'}</option>`; }
        } catch (e) { alert("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º"); }
    }

    document.getElementById('pkg_name').onchange = (e) => {
        const opt = e.target.options[e.target.selectedIndex];
        document.getElementById('sheet_name_hidden').value = opt.dataset.sheet;
        document.getElementById('table_id_hidden').value = opt.dataset.table;
    };

    // --- –¢–£–†–ò–°–¢–´ ---
    const urlParams = new URLSearchParams(window.location.search);
    const pilgrimsRaw = urlParams.get('pilgrims');
    if (pilgrimsRaw) {
        const pList = JSON.parse(decodeURIComponent(pilgrimsRaw));
        pilgrimsCount = pList.length;
        document.getElementById('pilgrims-container').innerHTML = pList.map(p => `
            <div class="tourist-card"><div class="tourist-name">üë§ ${p.name}</div><input type="tel" class="phone-input" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω"></div>
        `).join('');
    }
    if (tg.initDataUnsafe?.user) document.getElementById('manager').value = tg.initDataUnsafe.user.first_name;

    // --- –ü–ï–†–ï–•–û–î –ö–û 2 –®–ê–ì–£ ---
    function goToStep2() {
        if (!document.getElementById('pkg_name').value || !document.getElementById('price').value) {
            return alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ü–∞–∫–µ—Ç –∏ —É–∫–∞–∂–∏—Ç–µ –¶–µ–Ω—É!");
        }
        document.getElementById('step_1').style.display = 'none';
        document.getElementById('step_2').style.display = 'block';

        if (pilgrimsCount > 1) document.getElementById('group_logic').style.display = 'block';
        fetchAvailableRooms();
    }

    function backToStep1() {
        document.getElementById('step_2').style.display = 'none';
        document.getElementById('step_1').style.display = 'block';
    }

    function togglePlacementFields() {
        const meth = document.querySelector('input[name="place_method"]:checked').value;
        document.getElementById('rooms_list_container').style.display = meth === 'pick' ? 'block' : 'none';
        document.getElementById('manual_row_container').style.display = meth === 'manual' ? 'block' : 'none';
    }

    // --- –ó–ê–ü–†–û–° –ö–û–ú–ù–ê–¢ ---
    async function fetchAvailableRooms() {
        const roomSelect = document.getElementById('room_select');
        roomSelect.innerHTML = '<option>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–Ω–∞—Ç...</option>';

        const params = new URLSearchParams({
            table_id: document.getElementById('table_id_hidden').value,
            sheet_name: document.getElementById('sheet_name_hidden').value,
            package_name: document.getElementById('pkg_name').value,
            count: pilgrimsCount,
            room_type: document.getElementById('room').value
        });

        try {
            const resp = await fetch(`${API_URL}/api/rooms?${params}`, { headers: {"ngrok-skip-browser-warning":"1"} });
            const res = await resp.json();
            if (res.found && res.rooms.length > 0) {
                roomSelect.innerHTML = res.rooms.map(r => `
                    <option value="${r.row}">${r.gender === 'M'?'üöπ':'üö∫'} ${r.type} (–°–≤–æ–±: ${r.free}) [–¢—É—Ç: ${r.guests}]</option>
                `).join('');
            } else { roomSelect.innerHTML = '<option value="">–ù–µ—Ç –º–µ—Å—Ç –¥–ª—è –ø–æ–¥—Å–µ–ª–µ–Ω–∏—è</option>'; }
        } catch(e) { roomSelect.innerHTML = '<option>–û—à–∏–±–∫–∞ API</option>'; }
    }

    // --- –§–ò–ù–ê–õ–¨–ù–ê–Ø –û–¢–ü–†–ê–í–ö–ê ---
    function finalSubmit() {
        const method = document.querySelector('input[name="place_method"]:checked').value;
        let specific_row = null;
        if (method === 'pick') specific_row = document.getElementById('room_select').value;
        if (method === 'manual') specific_row = document.getElementById('manual_row_input').value;

        const data = {
            phones: Array.from(document.querySelectorAll('.phone-input')).map(i => i.value || "-"),
            pkg_name: document.getElementById('pkg_name').value,
            sheet_name: document.getElementById('sheet_name_hidden').value,
            table_id: document.getElementById('table_id_hidden').value,
            city: document.querySelector('input[name="city"]:checked').value,
            room: document.getElementById('room').value,
            visa: document.getElementById('visa').value,
            avia: document.getElementById('avia').value,
            meal: document.getElementById('meal').value,
            price: document.getElementById('price').value,
            paid: document.getElementById('paid').value,
            region: document.getElementById('region').value,
            manager: document.getElementById('manager').value,
            comment: document.getElementById('comment').value,
            // –†–∞–∑–º–µ—â–µ–Ω–∏–µ
            place_mode: document.querySelector('input[name="place_mode"]:checked')?.value || 'separate',
            place_method: method,
            specific_row: specific_row,
            is_share: method === 'pick'
        };

        tg.sendData(JSON.stringify(data));
        setTimeout(() => tg.close(), 150);
    }
</script>
</body>
</html>
