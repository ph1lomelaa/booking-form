<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; padding: 15px; padding-bottom: 50px; background-color: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000); }
        label { display: block; margin-top: 15px; font-weight: bold; color: var(--tg-theme-hint-color, #888); }
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; background: var(--tg-theme-secondary-bg-color, #f5f5f5); color: var(--tg-theme-text-color, #000); }
        
        .radio-group { display: flex; gap: 10px; margin-top: 5px; }
        .radio-group label { background: var(--tg-theme-secondary-bg-color, #f0f0f0); padding: 10px; border-radius: 8px; flex: 1; text-align: center; cursor: pointer; border: 1px solid transparent; }
        .radio-group input { display: none; }
        .radio-group input:checked + label { background: #e6f0ff; border-color: #3390ec; color: #3390ec; font-weight: bold; }

        .pilgrim-row { margin-bottom: 10px; padding: 10px; background: var(--tg-theme-secondary-bg-color, #f9f9f9); border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .pilgrim-name { font-weight: 500; font-size: 14px; width: 40%; }
        .pilgrim-phone { width: 55%; }
        
        button { width: 100%; padding: 15px; margin-top: 30px; background-color: var(--tg-theme-button-color, #3390ec); color: var(--tg-theme-button-text-color, #fff); border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="app">
    <h3>üì¶ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏</h3>
    
    <label>–ü–∞–∫–µ—Ç:</label>
    <select id="pkg_name"></select>

    <label>–ì–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞:</label>
    <div class="radio-group">
        <input type="radio" id="c1" name="city" value="–ê–ª–º–∞—Ç—ã" checked><label for="c1">–ê–ª–º–∞—Ç—ã</label>
        <input type="radio" id="c2" name="city" value="–ê—Å—Ç–∞–Ω–∞"><label for="c2">–ê—Å—Ç–∞–Ω–∞</label>
        <input type="radio" id="c3" name="city" value="–¢–∞—à–∫–µ–Ω—Ç"><label for="c3">–¢–∞—à–∫–µ–Ω—Ç</label>
        <input type="radio" id="c4" name="city" value="–®—ã–º–∫–µ–Ω—Ç"><label for="c4">–®—ã–º–∫–µ–Ω—Ç</label>
    </div>

    <label>üë• –¢–µ–ª–µ—Ñ–æ–Ω—ã —Ç—É—Ä–∏—Å—Ç–æ–≤:</label>
    <div id="pilgrims_container"></div>

    <label>üõè –¢–∏–ø –Ω–æ–º–µ—Ä–∞:</label>
    <select id="room">
        <option value="Quadro">Quadro (4-—Ö)</option>
        <option value="Triple">Triple (3-—Ö)</option>
        <option value="Double">Double (2-—Ö)</option>
        <option value="Single">Single (1)</option>
    </select>

    <div style="display:none;">
        <input id="train" value="-">
        <input id="region" value="-">
    </div>

    <label>üõÇ –í–∏–∑–∞:</label>
    <input type="text" id="visa" value="–£–º—Ä–∞ –í–∏–∑–∞">

    <label>‚úàÔ∏è –ê–≤–∏–∞:</label>
    <input type="text" id="avia" value="–ë–ª–æ–∫">

    <label>üçΩ –ü–∏—Ç–∞–Ω–∏–µ:</label>
    <select id="meal">
        <option value="BB">–ó–∞–≤—Ç—Ä–∞–∫–∏ (BB)</option>
        <option value="HB">–ó–∞–≤—Ç—Ä–∞–∫–∏+–£–∂–∏–Ω—ã (HB)</option>
        <option value="FB">3-—Ö —Ä–∞–∑–æ–≤–æ–µ (FB)</option>
    </select>

    <label>üí∞ –¶–µ–Ω–∞ ($):</label>
    <input type="number" id="price" placeholder="1250">

    <label>üíµ –û–ø–ª–∞—á–µ–Ω–æ ($):</label>
    <input type="number" id="paid" placeholder="0">

    <label>–ö—É—Ä—Å:</label>
    <input type="number" id="rate" placeholder="490">

    <label>–°–∫–∏–¥–∫–∞:</label>
    <input type="text" id="discount" placeholder="-">

    <label>–ò—Å—Ç–æ—á–Ω–∏–∫:</label>
    <input type="text" id="source" placeholder="–ò–Ω—Å—Ç–∞–≥—Ä–∞–º">

    <label>–ú–µ–Ω–µ–¥–∂–µ—Ä:</label>
    <input type="text" id="manager" placeholder="–ò–º—è">

    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
    <textarea id="comment" rows="2"></textarea>

    <button id="submitBtn" type="button">‚úÖ –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // 1. –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø (–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–∞–¥–∞–µ—Ç)
    function safeGet(id) {
        let el = document.getElementById(id);
        if (el) return el.value;
        return "-"; // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ—á–µ—Ä–∫
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    try {
        const params = new URLSearchParams(window.location.search);
        
        // –ü–∞–∫–µ—Ç—ã
        const pkgSelect = document.getElementById('pkg_name');
        const pkgs = (params.get('packages') || "").split('|');
        pkgs.forEach(p => {
            if(p) {
                let opt = document.createElement('option');
                opt.value = p; opt.innerText = p;
                pkgSelect.appendChild(opt);
            }
        });

        // –¢—É—Ä–∏—Å—Ç—ã
        const pCont = document.getElementById('pilgrims_container');
        const pData = JSON.parse(params.get('pilgrims') || "[]");
        pData.forEach((p, i) => {
            pCont.innerHTML += `
                <div class="pilgrim-row">
                    <span class="pilgrim-name">${i+1}. ${p.name}</span>
                    <div class="pilgrim-phone"><input class="ph-input" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" value="${p.phone||''}"></div>
                </div>`;
        });

    } catch (e) {
        alert("–û—à–∏–±–∫–∞ —Å—Ç–∞—Ä—Ç–∞: " + e.message); // –ü–æ–∫–∞–∂–µ—Ç –æ—à–∏–±–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    }

    // –ù–ê–ñ–ê–¢–ò–ï –ö–ù–û–ü–ö–ò
    document.getElementById('submitBtn').addEventListener('click', function() {
        // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏, —á—Ç–æ–±—ã –±—ã–ª–æ –≤–∏–¥–Ω–æ –Ω–∞–∂–∞—Ç–∏–µ
        this.innerText = "‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...";
        
        try {
            // –°–±–æ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
            let phones = [];
            document.querySelectorAll('.ph-input').forEach(i => phones.push(i.value || "-"));

            // –°–±–æ—Ä –≥–æ—Ä–æ–¥–∞ (–±–µ–∑–æ–ø–∞—Å–Ω–æ)
            let cityEl = document.querySelector('input[name="city"]:checked');
            let cityVal = cityEl ? cityEl.value : "–ê–ª–º–∞—Ç—ã";

            // –°–±–æ—Ä –æ–±—ä–µ–∫—Ç–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ safeGet
            let data = {
                phones: phones,
                pkg_name: safeGet("pkg_name"),
                city: cityVal,
                room: safeGet("room"),
                train: safeGet("train"),
                visa: safeGet("visa"),
                avia: safeGet("avia"),
                meal: safeGet("meal"),
                price: safeGet("price"),
                paid: safeGet("paid"),
                contract: "-", // –£–±—Ä–∞–ª–∏ ID contract, —à–ª–µ–º –ø—Ä–æ—á–µ—Ä–∫
                rate: safeGet("rate"),
                discount: safeGet("discount"),
                source: safeGet("source"),
                region: safeGet("region"), // –¢–µ–ø–µ—Ä—å –±–µ–∑–æ–ø–∞—Å–Ω–æ –≤–µ—Ä–Ω–µ—Ç "-"
                manager: safeGet("manager"),
                comment: safeGet("comment")
            };

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–Ω—ã
            if (!data.price || data.price === "-") {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¶–µ–Ω—É!");
                this.innerText = "‚úÖ –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É";
                return;
            }

            // –û–¢–ü–†–ê–í–ö–ê
            tg.sendData(JSON.stringify(data));
            
            // –ó–ê–ö–†–´–¢–ò–ï –° –ó–ê–î–ï–†–ñ–ö–û–ô (–ß—Ç–æ–±—ã –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ–ª–∏ —É–π—Ç–∏)
            setTimeout(function() {
                tg.close();
            }, 300);

        } catch (error) {
            alert("–û–®–ò–ë–ö–ê: " + error.message); // –≠–¢–û –û–ö–ù–û –ü–û–ö–ê–ñ–ï–¢ –ì–î–ï –ü–†–û–ë–õ–ï–ú–ê
            this.innerText = "‚ùå –û—à–∏–±–∫–∞";
        }
    });
</script>
</body>
</html>
