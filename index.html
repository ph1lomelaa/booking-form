<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #fff);
            --text-color: var(--tg-theme-text-color, #000);
            --hint-color: var(--tg-theme-hint-color, #999);
            --btn-color: var(--tg-theme-button-color, #3390ec);
            --btn-text: var(--tg-theme-button-text-color, #fff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
            --active-bg: rgba(51, 144, 236, 0.15);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 15px; padding-bottom: 40px; }

        label { display: block; margin-top: 15px; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--hint-color); text-transform: uppercase; letter-spacing: 0.5px; }

        /* === –ï–î–ò–ù–´–ô –°–¢–ò–õ–¨ –î–õ–Ø –í–°–ï–• –ü–û–õ–ï–ô === */
        select, input, textarea, .tourist-box {
            width: 100%;
            padding: 14px; /* –û–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä */
            border: 1px solid transparent;
            border-radius: 12px;
            background-color: var(--secondary-bg);
            color: var(--text-color);
            font-size: 16px;
            box-sizing: border-box;
            outline: none;
            transition: 0.2s;
            margin-top: 0;
        }
        select:focus, input:focus, textarea:focus {
            border-color: var(--btn-color);
            background-color: var(--bg-color);
            box-shadow: 0 0 0 3px rgba(51, 144, 236, 0.1);
        }

        .row { display: flex; gap: 12px; }
        .col { flex: 1; }

        /* === –ö–ù–û–ü–ö–ò –ì–û–†–û–î–ê === */
        .city-buttons { display: flex; gap: 10px; }
        .city-buttons input { display: none; }
        .city-buttons label {
            flex: 1;
            padding: 14px;
            text-align: center;
            background-color: var(--secondary-bg);
            color: var(--text-color);
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .city-buttons input:checked + label {
            background-color: var(--btn-color);
            color: var(--btn-text);
            border-color: var(--btn-color);
            box-shadow: 0 4px 12px rgba(51, 144, 236, 0.3);
        }

        /* === –ö–ê–†–¢–û–ß–ö–ê –¢–£–†–ò–°–¢–ê === */
        .tourist-card {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .tourist-name {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--btn-color);
        }

        button.submit-btn { width: 100%; padding: 16px; margin-top: 30px; border: none; border-radius: 14px; background-color: var(--btn-color); color: var(--btn-text); font-size: 16px; font-weight: 700; cursor: pointer; }
        button:active { transform: scale(0.98); }

        .info-box { background-color: var(--active-bg); padding: 12px; border-radius: 12px; font-size: 14px; font-weight: 500; margin-bottom: 20px; text-align: center; color: var(--btn-color); border: 1px solid var(--btn-color); }

        #train-block { display: none; margin-top: 15px; }
        .divider { height: 1px; background-color: var(--secondary-bg); margin: 25px 0; }
    </style>
</head>
<body>

<div id="date-display" class="info-box">üìÖ –ó–∞–≥—Ä—É–∑–∫–∞...</div>

<label>üì¶ –ü–∞–∫–µ—Ç:</label>
<select id="pkg_name" style="font-weight: bold;">
    <option value="" disabled selected>–ò—â—É –ø–∞–∫–µ—Ç—ã...</option>
</select>

<label>üõ´ –ì–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞:</label>
<div class="city-buttons">
    <input type="radio" name="city" id="c_ala" value="Almaty" checked>
    <label for="c_ala">Almaty</label>

    <input type="radio" name="city" id="c_ast" value="Astana">
    <label for="c_ast">Astana</label>
</div>

<div class="divider"></div>

<label>üë• –¢—É—Ä–∏—Å—Ç—ã –∏ –¢–µ–ª–µ—Ñ–æ–Ω—ã:</label>
<div id="pilgrims-container">
    <div class="tourist-card">
        <div class="tourist-name">üë§ –¢—É—Ä–∏—Å—Ç 1</div>
        <input type="tel" class="phone-input" placeholder="+7 (___) ___-__-__">
    </div>
</div>

<div class="divider"></div>

<div class="row">
    <div class="col">
        <label>‚úàÔ∏è –ê–≤–∏–∞:</label>
        <input type="text" id="avia" placeholder="KC 855 / Block">
    </div>
    <div class="col">
        <label>üõÇ –í–∏–∑–∞:</label>
        <select id="visa">
            <option value="UMRAH VISA">UMRAH VISA</option>
            <option value="TOUR VISA">TOUR VISA</option>
            <option value="KSA VISA">KSA VISA</option>
            <option value="NO VISA">NO VISA</option>
            <option value="OWN VISA">OWN VISA</option>
        </select>
    </div>
</div>

<div class="row">
    <div class="col">
        <label>üõè –ù–æ–º–µ—Ä:</label>
        <select id="room">
            <option value="Quad">Quad (4)</option>
            <option value="Triple">Triple (3)</option>
            <option value="Double">Double (2)</option>
            <option value="Single">Single (1)</option>
        </select>
    </div>
    <div class="col">
        <label>üçΩ –ü–∏—Ç–∞–Ω–∏–µ:</label>
        <select id="meal">
            <option value="BB">BB (–ó–∞–≤—Ç—Ä–∞–∫)</option>
            <option value="HB">HB (+–£–∂–∏–Ω)</option>
            <option value="FB">FB (3-—Ä–∞–∑)</option>
            <option value="RO">RO (–ë–µ–∑ –µ–¥—ã)</option>
        </select>
    </div>
</div>

<div id="train-block">
    <label>üöÜ –ü–æ–µ–∑–¥ (–µ—Å—Ç—å –≤ –ø–∞–∫–µ—Ç–µ):</label>
    <select id="train">
        <option value="-">–ù–µ—Ç, –Ω–µ –Ω—É–∂–µ–Ω</option>
        <option value="YES">‚úÖ –î–ê, –ù–£–ñ–ï–ù</option>
    </select>
</div>

<div class="divider"></div>

<div class="row">
    <div class="col">
        <label>üí∞ –¶–µ–Ω–∞ ($):</label>
        <input type="tel" id="price" placeholder="1200" inputmode="numeric">
    </div>
    <div class="col">
        <label>üíµ –û–ø–ª–∞—á–µ–Ω–æ:</label>
        <input type="tel" id="paid" placeholder="0" inputmode="numeric">
    </div>
</div>

<details style="margin-top: 20px; color: var(--btn-color); background: #fff; border-radius: 12px; padding: 5px; border: 1px solid var(--secondary-bg);">
    <summary style="font-weight: 600; padding: 10px; cursor: pointer;">üìÇ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ (–†–µ–≥–∏–æ–Ω, –î–æ–≥–æ–≤–æ—Ä...)</summary>

    <div style="padding: 10px;">
        <label>üåç –†–µ–≥–∏–æ–Ω (–ü—Ä–æ–ø–∏—Å–∫–∞):</label>
        <select id="region">
            <option value="Almaty" selected>Almaty</option>
            <option value="Astana">Astana</option>
            <option value="Aktau">Aktau</option>
            <option value="Shymkent">Shymkent</option>
            <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
            <option value="Atyrau">Atyrau</option>
            <option value="Aktobe">Aktobe</option>
            <option value="Karaganda">Karaganda</option>
            <option value="Taraz">Taraz</option>
            <option value="Oskemen">Oskemen</option>
            <option value="Semey">Semey</option>
            <option value="Pavlodar">Pavlodar</option>
            <option value="Uralsk">Uralsk</option>
            <option value="Kostanay">Kostanay</option>
            <option value="Kyzylorda">Kyzylorda</option>
            <option value="Turkestan">Turkestan</option>
            <option value="Kokshetau">Kokshetau</option>
        </select>

        <div class="row" style="margin-top: 15px;">
            <div class="col">
                <label>üìÑ –î–æ–≥–æ–≤–æ—Ä ‚Ññ:</label>
                <input type="text" id="contract" placeholder="-">
            </div>
            <div class="col">
                <label>üí≤ –ö—É—Ä—Å:</label>
                <input type="tel" id="rate" placeholder="495">
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label>üè∑ –°–∫–∏–¥–∫–∞:</label>
                <input type="text" id="discount" placeholder="-">
            </div>
            <div class="col">
                <label>üì¢ –ò—Å—Ç–æ—á–Ω–∏–∫:</label>
                <input type="text" id="source" placeholder="Instagram">
            </div>
        </div>
    </div>
</details>

<label>üë§ –ú–µ–Ω–µ–¥–∂–µ—Ä:</label>
<input type="text" id="manager" readonly style="opacity: 0.7; background: #e0e0e0;">

<label>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
<textarea id="comment" rows="2" placeholder="–í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏..."></textarea>

<button class="submit-btn" onclick="sendData()">‚úÖ –°–û–ó–î–ê–¢–¨ –ó–ê–Ø–í–ö–£</button>

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();

    const urlParams = new URLSearchParams(window.location.search);

    // 1. –î–ê–¢–ê
    const dateString = urlParams.get('date');
    if (dateString) {
        document.getElementById('date-display').innerText = `üìÖ –í—ã–ª–µ—Ç: ${dateString}`;
    }

    // 2. –°–ü–ò–°–û–ö –¢–£–†–ò–°–¢–û–í
    const pilgrimsRaw = urlParams.get('pilgrims');
    const pilgrimsContainer = document.getElementById('pilgrims-container');

    if (pilgrimsRaw) {
        try {
            const pilgrims = JSON.parse(decodeURIComponent(pilgrimsRaw));
            pilgrimsContainer.innerHTML = ""; // –û—á–∏—â–∞–µ–º –∑–∞–≥–ª—É—à–∫—É

            pilgrims.forEach((p, index) => {
                let div = document.createElement('div');
                div.className = 'tourist-card';
                div.innerHTML = `
                        <div class="tourist-name">üë§ ${p.name}</div>
                        <input type="tel" class="phone-input" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" value="${p.phone || ''}">
                    `;
                pilgrimsContainer.appendChild(div);
            });
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ª—é–¥–µ–π");
        }
    }

    // 3. –ü–ê–ö–ï–¢–´
    const pkgString = urlParams.get('packages');
    const select = document.getElementById('pkg_name');
    select.innerHTML = "";

    if (pkgString) {
        const packages = decodeURIComponent(pkgString).split('|');
        packages.forEach(pkg => {
            let opt = document.createElement('option');
            opt.value = pkg; opt.innerText = pkg;
            select.appendChild(opt);
        });
    } else {
        let opt = document.createElement('option');
        opt.innerText = "–ü–∞–∫–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã";
        select.appendChild(opt);
    }

    // 4. –ü–û–ï–ó–î
    const hasTrain = urlParams.get('train');
    if (hasTrain === '1') {
        document.getElementById('train-block').style.display = 'block';
    }

    // 5. –ú–ï–ù–ï–î–ñ–ï–†
    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
        document.getElementById('manager').value = tg.initDataUnsafe.user.first_name;
    }

    // 6. –û–¢–ü–†–ê–í–ö–ê
    function sendData() {
        let price = document.getElementById("price").value;
        if (!price) {
            tg.showPopup({title: "–û—à–∏–±–∫–∞", message: "–£–∫–∞–∂–∏—Ç–µ —Ü–µ–Ω—É!"});
            return;
        }

        // –°–æ–±–∏—Ä–∞–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω—ã
        let phones = [];
        document.querySelectorAll('.phone-input').forEach(input => {
            phones.push(input.value || "-");
        });

        // –ì–æ—Ä–æ–¥ –∏–∑ –∫–Ω–æ–ø–æ–∫
        let selectedCity = document.querySelector('input[name="city"]:checked').value;

        let data = {
            phones: phones, // –ú–∞—Å—Å–∏–≤ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤

            pkg_name: document.getElementById("pkg_name").value,
            city: selectedCity,
            room: document.getElementById("room").value,
            train: (hasTrain === '1') ? document.getElementById("train").value : "-",

            visa: document.getElementById("visa").value,
            avia: document.getElementById("avia").value,
            meal: document.getElementById("meal").value,
            price: price,
            paid: document.getElementById("paid").value || "0",
            contract: document.getElementById("contract").value || "-",
            rate: document.getElementById("rate").value || "-",
            discount: document.getElementById("discount").value || "-",
            source: document.getElementById("source").value || "-",

            region: document.getElementById("region").value,
            manager: document.getElementById("manager").value,
            comment: document.getElementById("comment").value
        };

        tg.sendData(JSON.stringify(data));
    }
</script>
</body>
</html>
